<html>
<head>
<style>
body { 
  font-family: "IBM Plex Sans", "Open Sans", Arial, Helvetica, sans-serif;
}
p.label {
  width: 90%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: block;
}
</style>

<script>
var SHOPPING_URL_BASE = 'https://www.instacart.com/store/metropolitan-market/search_v3/';


//--------------------------------------------------------------------------------
// ingredients & meals
//--------------------------------------------------------------------------------

var ingredients = [ 
"Salad Fixings & Veg",
 [ "Lettuce"          , "Bell Peppers"       ],
 [ "Avocados"         , "Carrots"            ],
 [ "Red Onion"        , "Green Onion"        ],
 [ "Cherry Tomatoes"  , "Regular Tomatoes"   ],
 [ ""                 , "Cucumber"           ],

"Fruit"               ,
 [ "Grapefruit"       , "Grapes"             ],
 [ "Apples"           , "Pears"              ],
 [ "Bananas"          , "Strawberries"       ],

"Dairy"               ,
 [ "Lowfat Milk"      , "Big Yogurt"         ],
 [ "Half and Half"    , "Small Yogurt"       ],
 [ "Almond Milk"      , "Eggs"               ],
 [ "Cream Cheese"     , "String Cheese"      ],
 [ ""                 , "Tillamook Loaf"     ],

"Bread"               ,
 [ "Sandwich Bread"   , "English Muffins"    ],
 [ "Essential Baking" , "Bagels"             ],

"Packaged Goods"      ,
 [ "Tuna Fish"        , "White Rice"         ],
 [ "Peanut Butter"    , "Jelly"              ],
 [ "Annie's"          , "La Croix"           ],
 [ "Cereal"           , "Hearts of Palm"     ],
 [ "Granola"          , "Salsa"              ],

"Lunches"             ,
 [ "Granola Bars"     , "Deli Meats"         ],
 [ "Crackers"         , "Fruit snacks/bites" ],

];

var meals = {
  "One-Pan Parsley Chicken & Potatoes"            : "1.5 lbs boneless skinless chicken thighs, 1.5 lbs Yukon Gold potatoes, 2 garlic cloves, 1/4 cup apple cider vinegar, 1 cup italian parsley, 1 lemon, 1 cup low-salt chicken broth, 1 tbsp dijon",
  "Rigatoni Bolognese"                            : "2 lbs ground beef, 2 yellow onion, 2 celery stalk, 2 carrot, 2x28 oz crushed tomatoes, 1/2 cup italian parsley, 16 basil leaves, 1/2 cup pecorino romano, 4 garlic cloves, olive oil",
  "Ruf Ruf Fajitas"                               : "2 avocados, 2/3 cup sour cream, 4 jalapenos, 2 cups cilantro, 6 limes, 2 lbs peeled deveined shrimp, fajita seasoning, 2 bell peppers, 6 pineapple rings, 8 flour tortillas, vegetable oil",
  "Salmon Salad /w Sesame Dressing"               : "1.5 lbs salmon filet, cherry tomatoes, 2 avocados, spring lettuce mix",
  "Seared Tuna w/ Avocado, Soy, Ginger, and Lime" : "2 lbs tuna, 2 cups cilantro, 1 jalapeno, 1 avocado, ginger, garlic, 2 limes, soy sauce, olive oil",
  "Slow Cooker Tom Kha Gai"                       : "6 lemongrass stalks, 6 cups low-sodium chicken broth, 1/2 cup fish sauce, ginger, 12 kaffir lime leaves, 2 shallots, 6 thai chiles, 3 lbs boneless skinless chicken thighs, 8 oz shiitake mushrooms, 2x13.5 oz coconut milk, 2 carrots, 6 limes, 1/2 cup cilantro, 4 tbsp thai basil, green onions, chili oil sauce",
  "Steak, Rice, and Sauce"                        : "2 lemon, 1 white onion, garlic, coriander seed, 1.5 lbs skirt steak, soy sauce, white vinegar, vegetable oil, broccoli",
  "Thai Cucumber Salad"                           : "red onion, 2 cucumbers, 1/3 cup cilantro, 1/2 cup salted peanuts, 1 jalapeno, 3 limes, garlic, fish sauce, vegetable oil",
  "Tofu Stir Fry"                                 : "tofu, carrots, red cabbage, bell pepper, thai eggplant, onion, celery",
  "Yogurt-and-Herb Pork Tenderloin"               : "2x12 oz pork tenderloin, 1/2 cup plain greek yogurt, tzatziki, 2 tbsp fresh mint",
};





//--------------------------------------------------------------------------------
// link generation
//--------------------------------------------------------------------------------

function genLinks(selected) {
  var ret = '';
  ret += genFreeTextLinks(document.getElementById('freeText').value);
  ret += genMealLinks();
  ret += genChecklistLinks(selected);
  return ret;
}

function genFreeTextLinks(text) {
  var ret = '';
  text.split('\n').forEach(function(line) { if (line != defaultFreeText) ret += genInstacartLink(line); });
  return ret;
}

function genMealLinks() {
  var ret = '';
  var i=0;
  document.getElementsByName('cbox_m').forEach(function(cbox) {
    if (! cbox.checked ) return;
    var name = cbox.value;
    var list = meals[name];
    ret += '<b>' + name + '</b><br/>';
    list.split(/ *, */).forEach(function(item) { ret += genInstacartLink(item, true); });
    ret += '</br>';
  });
  
  return ret;
}




function genChecklistLinks(selected) {
  var ret = '';
  var i=0;
  document.getElementsByName('cbox_i').forEach(function(cbox) {
    if (cbox.checked != selected) return;
    if (i++ % 5 == 0) ret += '<br/>';
    ret += genInstacartLink(cbox.value);
  });
  return ret;
}

function genInstacartLink(label, shouldSplit) {
  var nonce = new Date().getTime();
  var search = label;
  var display = label;

  if (shouldSplit) {
    var quantity = label.match(/([0-9x/.]+ (?:(?:cups?|lbs|oz|tsp|tbsp|cloves?) )?)(.*)/);
    if (quantity) { 
      search = quantity[2];
      display = quantity[2] + ' (' + quantity[1].trim() + ')';
      nonce = '--------' + quantity[1].trim().replace(' ', '-').toUpperCase() + '------------' + nonce;
    }
  }

  return '<div style="padding-top: 5px; padding-bottom: 0;"><a href="' + SHOPPING_URL_BASE + search + '#' + nonce + '">' + display + '</a></div>';
}


//--------------------------------------------------------------------------------
// checklist generation
//--------------------------------------------------------------------------------

function genInputs() {
  var ret = '<table id="checklistTable" style:"width:100%;">';
  ret += genFreeTextInput();
  ret += genMealInput();
  ret += genIngredientInput();
  return ret + '</table>';
}
  
var defaultFreeText = '(type stuff here)';
function genFreeTextInput() {
  return '<tr style="height:3em;"><td colspan=2 text-align:"left"><b>Free text</b></td></tr>'
   +'<tr><td colspan=2 style="align:left;"><textarea id="freeText" style="width:100%;height:150px;border:1px solid #AAA;vertical-align:top;">' + defaultFreeText + '</textarea></td></tr>';
}

function genMealInput() {
  var ret = '<tr style="height:3em;"><td colspan=2 style="align:left;"><b>Meals</b>';

  var i = 0;
  Object.keys(meals).forEach(function(meal) {
    ret += i++ % 2 == 0 ? '</td></tr><tr><td>' : '</td><td>';
    ret += cbox('m', meal);
  });
  ret += '</td></tr>'

  return ret;
}

function genIngredientInput() {
  var ret = '';
  ingredients.forEach(function(row) {
    ret += Array.isArray(row)
      ? ('<tr><td width=50%>' + cbox('i', row[0]) + '</td><td>' + cbox('i', row[1]) + '</td></tr>')
      : ('<tr style="height:3em;"><td colspan=2 style="align:left;"><b>' + row + '</b></td></tr>');
  });
  return ret;
}

function cbox(type, label) {
  if (!label) return '';
  return '<p class="label"><input type="checkbox" name="cbox_' + type + '" value="' + label + '">' + label + '</p>';
}


</script>
</head>
<body onload="javascript:checklist.innerHTML = genInputs();">
<br/><br/>
<button onclick="javascript:output.innerHTML = genLinks(true);">Shop selected</button> 
&nbsp;&nbsp;
<button onclick="javascript:output.innerHTML = genLinks(false);">Shop non-selected</button> 
<br/>
<br/>
<table cellspacing=0 cellpadding=4 width=100%><tr>
<td id="checklist" style="width: 50%; height:900px; vertical-align: top; overflow: wrap; border: 1px solid lightgrey;"></td>
<td id="output" style="width: 50%; vertical-align: top; border: 1px solid lightgrey;"></td>
</tr></table>
</body>
</html>
