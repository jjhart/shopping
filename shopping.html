<html>
<head>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans" />
<style>
body, table, p, button, input, textarea { 
  font-family: "Google Sans"; 
  font-weight: 400;
  font-size: 12px;
  color: rgba(0, 0, 0, 0.8);
}
:link {
  color: green;
  text-decoration: none;
}
:visited, :active {
  color: #999;
}
:hover {
  color: blue;
}
p.label {
  width: 90%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: block;
  border: 1px solid white;
}
p.label:hover {
  background-color: rgba(0, 255, 0, 0.1);
  border: 1px dotted lightgrey;
}
p.label input {
  vertical-align: bottom;
}
p.label {
  padding: 2;
  vertical-align: top;
}
  
</style>

<script>
var STORE = 'metropolitan-market'; 
// var STORE = 'qfc';
var SHOPPING_URL_BASE = 'https://www.instacart.com/store/' + STORE + '/search_v3/';
var NOW = new Date().getTime();

//--------------------------------------------------------------------------------
// ingredients & meals
//--------------------------------------------------------------------------------

var ingredients = [ 
"Salad Fixings & Veg",
 [ "Lettuce"          , "Bell Peppers"       ],
 [ "Avocados"         , "Carrots"            ],
 [ "Red Onion"        , "Green Onion"        ],
 [ "Cherry Tomatoes"  , "Regular Tomatoes"   ],
 [ ""                 , "Cucumber"           ],

"Fruit"               ,
 [ "Grapefruit"       , "Grapes"             ],
 [ "Apples"           , "Pears"              ],
 [ "Bananas"          , "Strawberries"       ],

"Dairy"               ,
 [ "Lowfat Milk"      , "Greek gods yogurt"  ],
 [ "Half and Half"    , "Fage Yogurt"        ],
 [ "Almond Milk"      , "Eggs"               ],
 [ "Cream Cheese"     , "String Cheese"      ],
 [ ""                 , "Tillamook Loaf"     ],

"Bread"               ,
 [ "Sandwich Bread"   , "English Muffins"    ],
 [ "Essential Baking" , "Bagels"             ],

"Packaged Goods"      ,
 [ "Tuna Fish"        , "White Rice"         ],
 [ "Peanut Butter"    , "Jelly"              ],
 [ "Annie's"          , "La Croix"           ],
 [ "Cereal"           , "Hearts of Palm"     ],
 [ "Granola"          , "Salsa"              ],

"Lunches"             ,
 [ "Granola Bars"     , "Sliced Turkey"      ],
 [ "Crackers"         , "Fruit snacks/bites" ],
 [ "Frozen Burritos"  , "Frozen Pizza"       ],
 [ "Canned Soup" , "" ]

];

var meals = {
  ""                                               : "" // dummy just so everything else can have leading comma for ease of alphasort
  ,"BLT"                                           : "bacon, bread, lettuce, tomatoes"
  ,"Chicken Caesar"                                : "2 lbs chicken breasts, croutons, romaine, cherry tomatoes, parmesan cheese, caesar dressing, hearts of palm"
  ,"Chorizo & White Bean Stew (doubled)"           : "2 lbs mild italian sausage, 2 large onion, 8 garlic cloves, thyme, 4 15oz cans cannellini beans, 4 cups chicken broth, 10 oz baby spinach"
  ,"Fettucine with Zucchini"                       : "1 lb zucchini, 1 yellow onion, 1 cup pine nuts, 1lb fresh fettucine, flat-leaf parsley, 1/2 cup Grana Padano, olive oil, garlic"
  ,"Grilled Chicken w/ lemon,garlic,oregano"       : "12 boneless skinless chicken thighs, 7 lemons, fresh oregano, garlic, olive oil"
  ,"Grilled Pork Tenderloin ala Rodriguez"         : "1 cup guava jelly or apricot jam, 1/2 cup dijon, 4 cups orange juice, 1 red onion, 4 cloves garlic, 4 limes, 1 habanero, 1/2 cup cilantro, 1 tsp cumin seeds, 2x1.5 lb pork tenderloin"
  ,"Herb Roasted Chicken w/ Spinach Bean Salad"    : "4 chicken breasts, 3 lemons, thyme, 2 15oz cans cannelini beans, 1/4 cup grated parmesan, 10 cups spinach"
  ,"Italian Tuna Salad"                            : "1 lemons, 2x5oz cans St Jude Tuna, pitted kalamata olives, 1/2 cup fennel"
  ,"Lasagna"                                       : "20oz sweet italian sausage, 8oz lean ground beef, 1 yellow onion, 3 28oz cans whole tomatoes, 2 tbsp tomato paste, 2tbsp basil leaves, 1 egg, 15oz ricotta cheese, 3/4 cup grated parmesan, 1 package lasagna noodles, 2 cloves garlic"
  ,"Linguine with Clams"                           : "2 lbs cockles, 1 lb linguine, 1/3 cup bottled clam juice, 1/3 cup dry white wine, flat-leaf parsley, medium onion, essential baking rosemary diamante, 6 garlic cloves, olive oil, red pepper flakes, dried oregano"
  ,"Nigerian Beef Stew"                            : " 5 plum tomatoes, 1 red bell pepper, 1 red onion, 2 habanero peppers, 6 cloves garlic, 12oz tomato paste, 1.5 lbs flank steak, 2 cubes beef stock, 1 bay leaf, 1 tsp paprika, 1 tsp curry powder"
  ,"One-Pan Parsley Chicken & Potatoes"            : "1.5 lbs boneless skinless chicken thighs, 1.5 lbs Yukon Gold potatoes, 2 garlic cloves, 1/4 cup apple cider vinegar, 1 cup italian parsley, 1 lemon, 1 cup low-salt chicken broth, 1 tbsp dijon"
  ,"Pot stickers with Tomato Sauce"                : "Frozen dumplings, canned tomatoes, garlic, thyme, fish sauce, brown sugar, cream, parmesan, olive oil, red pepper flakes"
  ,"Power Outage Pasta"                            : "8 oz sweet italian sausage, 1 large onion, 1 red bell pepper, 1 yellow bell pepper, 4 garlic cloves, 1/4 cup dry white wine, 1x28oz whole tomatoes, 1 tsp dried oregano, 1 lb bucatini, 1/2 cup italian parsley, 1/2 cup Gran Padano"
  ,"Rice and Bean Bowl"                            : "2 cans black beans, taco seasoning, 1 bell pepper, cilantro, limes (for rice), white onion, avocado, cherry tomatoes, lettuce"
  ,"Rigatoni Bolognese (doubled)"                  : "2 lbs ground beef, 1 lb rigatoni, 2 yellow onion, 2 celery stalk, 2 carrot, 2x28 oz crushed tomatoes, 1/2 cup italian parsley, 16 basil leaves, 1/2 cup pecorino romano, 4 garlic cloves, olive oil, garlic bread"
  ,"Ruf Ruf Fajitas"                               : "2 avocados, 2/3 cup sour cream, 4 jalapenos, 2 cups cilantro, 6 limes, 2 lbs peeled deveined shrimp, fajita seasoning, 2 bell peppers, 6 pineapple rings, 8 flour tortillas, vegetable oil"
  ,"Salmon Salad w/ Sesame Dressing"               : "1.5 lbs salmon filet, cherry tomatoes, 2 avocados, spring lettuce mix"
  ,"Seared Scallops with Pan Sauce"                : "1.5 lbs sea scallops, 1 lemon, chives, 1/2 cupy dry white wine, garlic, butter, olive oil"
  ,"Seared Tuna w/ Avocado, Soy, Ginger, and Lime" : "2 lbs tuna, 2 cups cilantro, 1 jalapeno, 1 avocado, ginger, garlic, 2 limes, soy sauce, olive oil"
  ,"Sheet-Pan Salmon & Broccoli w/ Sesame + Ginger": "4x6 oz skin-on salmon fillets, ginger, 1 clove garlic, 1lb broccoli, 2 scallions, 1 lime, sesame seeds"
  ,"Slow-Cooker Green Chicken Chili"               : "3 lbs boneless skinless chicken thighs, 2 lbs sweet potatoes, 16 oz frontera tomatillo salsa, 2 cups chicken broth, 2 cans pinto beans, avocado, cilantro, sour cream, white onion"
  ,"Sole En Papillote"                             : "ciabatta bread, 4x6 oz sole filets, 1 cup grape tomatoes, fresh thyme, 2 tbsp capers, kalamata olives, 8 tsp dry white wine, garlic, red pepper flakes, olive oil"
  ,"Spiced Chickpea Stew w/ Coconut & Turmeric"    : "1 yellow onion, 1 piece ginger, turmeric, red pepper flakes, 2x15 oz cans chickpeas, 2x15 cans coconut milk, 2 cups vegetable stock, kale, 1 cup mint leaves, yogurt, pita, 1/4 cup olive oil, 4 garlic cloves"
  ,"Steak, Rice, and Sauce"                        : "broccoli, 1.5 lbs skirt steak, 2 lemon, 1 white onion, soy sauce, white vinegar, garlic, coriander seed, vegetable oil"
  ,"Tacos"                                         : "1lb ground beef, taco seasoning, taco shells, cherry tomatoes, lettuce, cheddar cheese, avocado, salsa, white onion"
  ,"Thai Chicken with Basil (doubled)"             : "2 lbs boneless skinless chicken breast, 6 shallots, 4 cups basil (2 big clamshells), 6 garlic cloves, 6 thai chiles, fish sauce, oyster sauce, white vinegar, sugar"
  ,"Thai Cucumber Salad"                           : "red onion, 2 cucumbers, 1/3 cup cilantro, 1/2 cup salted peanuts, 1 jalapeno, 3 limes, garlic, fish sauce, vegetable oil"
  ,"Tofu Stir Fry"                                 : "tofu, carrots, red cabbage, bell pepper, thai eggplant, onion, celery, cherry tomatoes"
  ,"Tom Kha Gai (doubled)"                         : "6 lemongrass stalks, 6 cups low-sodium chicken broth, 1/2 cup fish sauce, ginger, 12 kaffir lime leaves, 2 shallots, 6 thai chiles, 3 lbs boneless skinless chicken thighs, 8 oz shiitake mushrooms, 2x13.5 oz coconut milk, 2 carrots, 6 limes, 1/2 cup cilantro, 4 tbsp thai basil, green onions, chili oil sauce"
  ,"Yogurt-and-Herb Pork Tenderloin"               : "2x12 oz pork tenderloin, 1/2 cup plain greek yogurt, tzatziki, 2 tbsp fresh mint"
};





//--------------------------------------------------------------------------------
// Instacart link generation (from selected items)
//--------------------------------------------------------------------------------

function genLinks(selected) {
  var ret = '';
  ret += genFreeTextLinks(document.getElementById('freeText').value);
  ret += genMealLinks();
  ret += genChecklistLinks(selected);
  return ret;
}

function genFreeTextLinks(text) {
  var ret = '';
  text.split('\n').forEach(function(line) { if (line != defaultFreeText) ret += genInstacartLink(line); });
  return ret;
}

function genMealLinks() {
  var ret = '';
  var i=0;
  document.getElementsByName('cbox_m').forEach(function(cbox) {
    if (! cbox.checked ) return;
    var name = cbox.value;
    var list = meals[name];
    ret += '<br/><b>' + name + '</b><br/>';
    list.split(/ *, */).forEach(function(item) { ret += genInstacartLink(item, true); });
    ret += '</br>';
  });
  
  return ret;
}

function genChecklistLinks(selected) {
  var ret = '';
  var i=0;
  document.getElementsByName('cbox_i').forEach(function(cbox) {
    if (cbox.checked != selected) return;
    if (i++ % 5 == 0) ret += '<br/>';
    ret += genInstacartLink(cbox.value);
  });
  return ret;
}

function genInstacartLink(label, shouldSplit) {
  var nonce = NOW;
  var search = label;
  var display = label;

  if (shouldSplit) {
    var quantity = label.match(/([0-9/.]+x? ?(?:(?:cups?|lbs?|oz|tsps?|tbsps?|pieces?|inche?s?|cans?|cloves?) )?)(.*)/);
    if (quantity) { 
      search = quantity[2];
      display = quantity[2] + ' (' + quantity[1].trim() + ')';
      nonce = '--------' + quantity[1].trim().replace(' ', '-').toUpperCase() + '------------' + nonce;
    }
  }

  return '<div style="padding-top: 5px; padding-bottom: 0;"><a href="' + SHOPPING_URL_BASE + search + '#' + nonce + '">' + display + '</a></div>';
}



//--------------------------------------------------------------------------------
// checklist generation
//--------------------------------------------------------------------------------

function genInputs() {
  var ret = '<table id="checklistTable" style:"width:100%;">';
  ret += genFreeTextInput();
  ret += genMealInput();
  ret += genIngredientInput();
  return ret + '</table>';
}
  
var defaultFreeText = '(type stuff here)';
function genFreeTextInput() {
  return '<tr style="height:4em;"><td colspan=2 text-align:"left"><b>Free text</b></td></tr>'
   +'<tr><td colspan=2 style="align:left;"><textarea id="freeText" style="width:100%;height:150px;border:1px solid #AAA;vertical-align:top;padding:15px;">' + defaultFreeText + '</textarea></td></tr>';
}

function genMealInput() {
  var ret = '<tr style="height:3em;"><td colspan=2 style="align:left;"><b>Meals</b>';

  var i = 0;
  Object.keys(meals).forEach(function(meal) {
    if (meal == "") return;
    ret += i++ % 2 == 0 ? '</td></tr><tr><td>' : '</td><td>';
    ret += cbox('m', meal);
  });
  ret += '</td></tr>'

  return ret;
}

function genIngredientInput() {
  var ret = '';
  ingredients.forEach(function(row) {
    ret += Array.isArray(row)
      ? ('<tr><td width=50%>' + cbox('i', row[0]) + '</td><td>' + cbox('i', row[1]) + '</td></tr>')
      : ('<tr style="height:5em;vertical-align:bottom;"><td colspan=2 style="align:left;"><b>' + row + '</b></td></tr>');
  });
  return ret;
}

function cbox(type, label) {
  if (!label) return '';
  var cboxName = "cbox_" + type;
  var cboxId = cboxName + "_" + label;
  return '<p class="label" onclick="javascript:document.getElementById(\''+cboxId+'\').click();"><input onclick="javascript:event.cancelBubble=true;" type="checkbox" id="'+cboxId+'" name="'+cboxName+'" value="' + label + '">' + label + '</p>';
}


</script>
</head>
<body onload="javascript:checklist.innerHTML = genInputs();">
<br/><br/>
<button onclick="javascript:output.innerHTML = genLinks(true);">Shop selected</button> 
&nbsp;&nbsp;
<button onclick="javascript:output.innerHTML = genLinks(false);">Shop non-selected</button> 
<br/>
<br/>
<table cellspacing=0 cellpadding=4 width=100%><tr>
<td id="checklist" style="width: 50%; height:900px; vertical-align: top; overflow: wrap; border: 1px solid lightgrey;"></td>
<td id="output" style="width: 50%; vertical-align: top; border: 1px solid lightgrey;"></td>
</tr></table>
</body>
</html>
